<!DOCTYPE html>
<html lang="en" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="home">
<head>
  <meta charset="UTF-8">
<title>Profile</title>
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
<link rel="stylesheet" href="/ERPPro/css/userProfile.css">


</head>
<body>

<div layout:fragment="content">


<div class="container p-0">
    <h1 class="h3 mb-3">Settings</h1>
    <div class="row">
        <div class="col-md-5 col-xl-4">

            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Profile Settings</h5>
                </div>

                <div class="list-group list-group-flush" role="tablist">
                    <a class="list-group-item list-group-item-action active" data-toggle="list" href="#account" role="tab">
                      Account
                    </a>
                    <a class="list-group-item list-group-item-action" data-toggle="list" href="#password" role="tab">
                      Password
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-7 col-xl-8">
            <div class="tab-content">
                <div class="tab-pane fade show active" id="account" role="tabpanel">

                    <div class="card cardimage">
                        <div class="card-header">
                           
                            <h5 class="card-title mb-0">Profile Image</h5>
                        </div>
                        <div class="card-body">
                            <form>
	                               <div class="profile-pic">
									  <label class="-label" for="file">
									    <span class="glyphicon glyphicon-camera"></span>
									    <span>Change Image</span>
									  </label>
									  <input id="file" type="file" onchange="uploadFile()"/>
									  <img src="https://cdn.pixabay.com/photo/2017/08/06/21/01/louvre-2596278_960_720.jpg" id="output" width="200" />
									</div>
									
                           
                            </form>

                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-actions float-right">
                                <div class="dropdown show">
                                    <a href="#" data-toggle="dropdown" data-display="static">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-horizontal align-middle">
                                            <circle cx="12" cy="12" r="1"></circle>
                                            <circle cx="19" cy="12" r="1"></circle>
                                            <circle cx="5" cy="12" r="1"></circle>
                                        </svg>
                                    </a>

                                
                                </div>
                            </div>
                            <h5 class="card-title mb-0">Public Info</h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" id="user-form" th:action="@{/user/updateProfile}" th:object="${user}" >
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="inputFirstName">First name</label>
                                        <input type="text" class="form-control" id="inputFirstName" placeholder="First name" th:field="*{firstname}">
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label for="inputLastName">Last name</label>
                                        <input type="text" class="form-control" id="inputLastName" placeholder="Last name" th:field="*{lastname}">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="inputEmail4">Email</label>
                                    <input type="email" class="form-control" id="inputEmail4" placeholder="Email" th:field="*{email}" readonly="readonly">
                                </div>
                                <div class="form-group">
                                    <label for="inputAddress">Adresse</label>
                                    <input type="text" class="form-control" id="inputAddress" placeholder="1234 Main St" th:field="*{addresse}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="inputAddress">Date de création</label>
                                    <input type="text" class="form-control" id="inputdatec" placeholder="1234 Main St" th:field="*{datecreation}" readonly="readonly">
                                </div>
                              
                             
                                <button type="submit" class="btn btn-primary" onclick="updateProfile(event)">Save changes</button>
                            </form>
                            
                            <form method="POST" id="cl-form" th:action="@{/user/updateProfile}" th:object="${cl}" >
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="inputFirstName">Libelle</label>
                                        <input type="text" class="form-control" id="inputFirstName" placeholder="Libelle" th:field="*{Libelle}">
                                    </div>
                                   
                                </div>
                                <div class="form-group">
                                    <label for="inputEmail4">Email</label>
                                    <input type="email" class="form-control" id="inputEmail4" placeholder="Email" th:field="*{email}" readonly="readonly">
                                </div>
                                <div class="form-group">
                                    <label for="inputAddress">Address</label>
                                    <input type="text" class="form-control" id="inputAddress" placeholder="1234 Main St" th:field="*{addresse}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="inputAddress">Date de création</label>
                                    <input type="text" class="form-control" id="inputdatec" placeholder="1234 Main St" th:field="*{datecreation}" readonly="readonly">
                                </div>
                              
                             
                                <button type="submit" class="btn btn-primary" onclick="updateProfilecl(event)">Save changes</button>
                            </form>

                        </div>
                    </div>

                </div>
                <div class="tab-pane fade" id="password" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Password</h5>

                            <form  method="POST"  th:action="@{/user/updatePassword}" th:object="${user}" id="user-pass-form">
                                <div class="form-group">
                                    <label for="inputPasswordCurrent">Current password</label>
                                    <input type="password" class="form-control" id="inputPasswordCurrent">
                                    <small><a href="#">Forgot your password?</a></small>
                                </div>
                                <div class="form-group">
                                    <label for="inputPasswordNew">New password</label>
                                    <input type="password" class="form-control" th:field="*{password}" id="inputPasswordNew">
                                </div>
                                <div class="form-group">
                                    <label for="inputPasswordNew2">Verify password</label>
                                    <input type="password" class="form-control" id="inputPasswordNew2">
                                </div>
                                <button type="submit" class="btn btn-primary" onclick="updatePass(event)">update</button>
                            </form>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
	<div class="alert alert-success alert-dismissible fade bottom-right" role="alert" >
  <div style="text-align: center;">
    <strong>Succès!</strong><br><span class="alert-text"> Utilisateur ajouté avec succès !.</span>
  </div>
  <button type="button" class="close" onclick="hideCustomAlert()" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
</div>
<script
  src="https://code.jquery.com/jquery-3.6.4.js"
  integrity="sha256-a9jBBRygX1Bh5lt8GZjXDzyOB+bWve9EiO7tROUtj/E="
  crossorigin="anonymous"></script>
<script>
var token=sessionStorage.getItem('token');
var image=""
	function updateFields(user){
	
	const date1 = new Date(user.datecreation);
	const formattedDate = date1.toISOString().split('T')[0];
		document.getElementById('inputFirstName').value=user.firstname;
    	document.getElementById('inputLastName').value=user.lastname;
    	document.getElementById('inputEmail4').value=user.email;
    	document.getElementById('inputAddress').value=user.addresse;
    	document.getElementById('inputdatec').value=formattedDate;
		console.log(user.image)
    	fetch('/ERPPro/home/downloadImage?name='+user.image, {
            method: 'GET',
            headers: {
       	 	 'Authorization': `Bearer ${token}`
       	 	    },
        })
        .then(response => response.text())
        .then(data => {
            console.log(data); 
            document.getElementById('output').src =data
            updateImage(data)
        })
        .catch(error => {
            console.error('Error downloading file:', error);
        });
		}

function updateFieldscl(user){
	
	const date1 = new Date(user.datecreation);
	const formattedDate = date1.toISOString().split('T')[0];
	document.getElementById('inputFirstName').value=user.libelle;
	
	document.getElementById('inputEmail4').value=user.email;
	document.getElementById('inputAddress').value=user.addresse;
	document.getElementById('inputdatec').value=formattedDate;
	console.log(user.image)
	fetch('/ERPPro/home/downloadImage?name='+user.image, {
        method: 'GET',
        headers: {
   	 	 'Authorization': `Bearer ${token}`
   	 	    },
    })
    .then(response => response.text())
    .then(data => {
        console.log(data); 
        document.getElementById('output').src =data
        updateImage(data)
    })
    .catch(error => {
        console.error('Error downloading file:', error);
    });
	}
		function updateProfilecl(e){
			e.preventDefault();
			 var formData = new FormData(document.getElementById('cl-form'));
			 formData.append('image', image);
			 const alert = document.querySelector(".alert");
			 var userId =  sessionStorage.getItem("id");
			 formData.append('idU', userId);

		        // Perform an asynchronous request (e.g., using Fetch API or XMLHttpRequest)
		        fetch('/ERPPro/client/updateProfilecl', {
		            method: 'PUT',
		            headers: {
	           	 	 'Authorization': `Bearer ${token}`
	           	 	    },
		            body: formData
		        })
		        .then(response => response.json())
		        .then(data => {	
		        	
		        	updateFieldscl(data)
		        	  alert.querySelector('strong').textContent="Succès!";
		              alert.querySelector('.alert-text').textContent="Profile modifié avec succès !.";
		              alert.classList.add("alert-success");
		              alert.classList.remove("alert-danger");
		        		alert.classList.add("show");

		            // Set a timeout to hide the alert after 5000 milliseconds (5 seconds)
		            setTimeout(function () {
		                alert.classList.remove("show");
		            }, 5000);
		        
			})
		        .catch(error => {
		            // Handle errors if needed
		            console.error('Error adding user:', error);
		        });
			}
	function updateProfile(e){
		e.preventDefault();
		 var formData = new FormData(document.getElementById('user-form'));
		 formData.append('image', image);
		 const alert = document.querySelector(".alert");
		 var userId =  sessionStorage.getItem("id");
		 formData.append('idU', userId);

	        // Perform an asynchronous request (e.g., using Fetch API or XMLHttpRequest)
	        fetch('/ERPPro/user/updateProfile', {
	            method: 'PUT',
	            headers: {
           	 	 'Authorization': `Bearer ${token}`
           	 	    },
	            body: formData
	        })
	        .then(response => response.json())
	        .then(data => {	
	        	
	        		updateFields(data)
	        	  alert.querySelector('strong').textContent="Succès!";
	              alert.querySelector('.alert-text').textContent="Profile modifié avec succès !.";
	              alert.classList.add("alert-success");
	              alert.classList.remove("alert-danger");
	        		alert.classList.add("show");

	            // Set a timeout to hide the alert after 5000 milliseconds (5 seconds)
	            setTimeout(function () {
	                alert.classList.remove("show");
	            }, 5000);
	        
		})
	        .catch(error => {
	            // Handle errors if needed
	            console.error('Error adding user:', error);
	        });
		}


	function updatePass(e){
		e.preventDefault();
		 var userId =  sessionStorage.getItem("id");
		 
		 const alert = document.querySelector(".alert");
		 var formData = new FormData(document.getElementById('user-pass-form'));
		 formData.append('idU', userId);
			var oldpass=document.getElementById('inputPasswordCurrent').value	
			var newpass=document.getElementById('inputPasswordNew').value	
			var newpass1=document.getElementById('inputPasswordNew2').value		
	
			if(newpass == newpass1){
	        // Perform an asynchronous request (e.g., using Fetch API or XMLHttpRequest)
	        fetch('/ERPPro/user/updatePassword?oldpass='+oldpass, {
	            method: 'PUT',
	            headers: {
           	 	 'Authorization': `Bearer ${token}`
           	 	    },
	            body: formData
	        })
	        .then(response => response.text())
	        .then(data => {	
	           if(data = true){
	        		document.getElementById('inputPasswordCurrent').value=""	
		    		document.getElementById('inputPasswordNew').value=""	
		    		document.getElementById('inputPasswordNew2').value=""	
	        	   document.querySelector('[href="#account"]').click();
	        	  alert.querySelector('strong').textContent="Succès!";
	              alert.querySelector('.alert-text').textContent="mot de pass modifié avec succès !.";
	              alert.classList.add("alert-success");
	              alert.classList.remove("alert-danger");
	        		alert.classList.add("show");

	            // Set a timeout to hide the alert after 5000 milliseconds (5 seconds)
	            setTimeout(function () {
	                alert.classList.remove("show");
	            }, 5000);
	           }
	           else{
	        		document.getElementById('inputPasswordCurrent').value=""	
	    			document.getElementById('inputPasswordNew').value=""	
	    			document.getElementById('inputPasswordNew2').value=""		
	        	   alert.querySelector('strong').textContent="Attention!";
		              alert.querySelector('.alert-text').textContent="Verifier votre ancien mot de passe !.";
		              alert.classList.add("alert-danger");
		              alert.classList.remove("alert-success");
		        		alert.classList.add("show");

		            // Set a timeout to hide the alert after 5000 milliseconds (5 seconds)
		            setTimeout(function () {
		                alert.classList.remove("show");
		            }, 5000);
		           }
	        
		})
	        .catch(error => {
	            // Handle errors if needed
	            console.error('Error adding user:', error);
	        });
			}
			else{

				 alert.querySelector('strong').textContent="Attention!!";
	              alert.querySelector('.alert-text').textContent="Les champs du mot de passe et de confirmation ne correspondent pas !.";
	              alert.classList.add("alert-danger");
	              alert.classList.remove("alert-success");
	        		alert.classList.add("show");

	            // Set a timeout to hide the alert after 5000 milliseconds (5 seconds)
	            setTimeout(function () {
	                alert.classList.remove("show");
	            }, 5000);
				}
		}
</script>

<script>
function downloadImage(name){
	console.log(name)

	fetch('/ERPPro/home/downloadImage?name='+name, {
        method: 'GET',
        headers: {
   	 	 'Authorization': `Bearer ${token}`
   	 	    },
       
    })
    .then(response => response.text())
    .then(data => {
        console.log(data); 
        document.getElementById('output').src =data
    })
    .catch(error => {
        console.error('Error downloading file:', error);
    });
}

function uploadFile() {
    // Get the selected file
    var fileInput = document.getElementById('file');
    var file = fileInput.files[0];

    // Create a FormData object to append the file
    var formData = new FormData();
    formData.append('imageFile', file);

    // Perform an asynchronous request (e.g., using Fetch API or XMLHttpRequest)
    fetch('/ERPPro/home/uploadImage', {
        method: 'POST',
        headers: {
   	 	 'Authorization': `Bearer ${token}`
   	 	    },
        body: formData
    })
    .then(response => response.text())
    .then(data => {
        console.log(data);
        image=data
        downloadImage(data)
    })
    .catch(error => {
        console.error('Error uploading file:', error);
    });
}
</script>

<script type="text/javascript">

document.addEventListener("DOMContentLoaded", function() {

	if(sessionStorage.getItem("email") ==null){
  		window.location.href = '/ERPPro/home/login'
  		}
 
	 var userId =  sessionStorage.getItem("id");
	image=sessionStorage.getItem("image");
	var type="";
	fetch('/ERPPro/home/getUserType?email='+sessionStorage.getItem("email"), {
        method: 'GET',
        headers: {
        	 'Authorization': `Bearer ${token}`
        	    },
       
    })
    .then(response => response.text())
    .then(data => {
        type=data;
        if(data=="Client"){
            console.log("we are the champions")
        	  const form = document.getElementById('user-form');
    if (form) {
        console.log('Form found:', form);
        form.style.display = 'none';
    } else {
        console.log('Form not found');
    }
        	 document.getElementById('cl-form').style.display = 'block';
            }
        else{
        	 document.getElementById('user-form').style.display = 'block';
        	 document.getElementById('cl-form').style.display = 'none';
            }
        
    });
	  fetch('/ERPPro/user/userById/'+userId, {
	        method: 'GET',
	        headers: {
       	 	 'Authorization': `Bearer ${token}`
       	 	    },
	    })
	    .then(response => response.json())
	    .then(data => {
	    	if(type=="Client"){
	    		updateFieldscl(data)
		    	}
	    	else{
	    		updateFields(data)
		    	}
	    	
	    })
});
</script>

<script>
function hideCustomAlert(){
	 const alert = document.querySelector(".alert");
	 alert.classList.remove("show");
}</script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

	
	
	
</body>
</html>